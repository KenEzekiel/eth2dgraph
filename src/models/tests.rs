
use std::{str::FromStr, time::Duration};
use ethers::{types::{Address}, providers::{RetryClientBuilder, Http}, prelude::k256::pkcs8::der::oid::Arc};
use reqwest::Url;
use super::Contract;

#[test]
fn contract_serialization() {
    let raw_abi = "[{\"type\":\"function\",\"name\":\"name\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"approve\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"totalSupply\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transferFrom\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"decimals\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"withdrawEther\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"burn\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"balanceOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"owner\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"symbol\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"freezeOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"allowance\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false}, {\"type\":\"error\",\"name\":\"transferFromFailed\",\"inputs\":[]}]";
    let abi: Vec<ABIStructure> = serde_json::from_str(raw_abi).unwrap();
    let abi = ContractABI::new(abi);
    let address = Address::from_str("0xaa3ccffac657cac79dc06226b8d7fcc38e5dd300").unwrap();

    let mut contract = Contract::new(address);
    contract.abi = Some(abi);

    let serialized = serde_json::to_string(&contract).unwrap();

    println!("{}", serialized);
}

#[tokio::test]
  async fn insert_two_equal_contracts() {

    let client = dgraph_tonic::Client::new("http://localhost:9080").unwrap();

    let raw_abi = "[{\"type\":\"function\",\"name\":\"name\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"approve\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"totalSupply\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transferFrom\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"decimals\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"withdrawEther\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"burn\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"balanceOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"owner\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"symbol\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"freezeOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"allowance\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false}, {\"type\":\"error\",\"name\":\"transferFromFailed\",\"inputs\":[]}]";
    let abi: Vec<ABIStructure> = serde_json::from_str(raw_abi).unwrap();
    let abi = ContractABI::new(abi);

    let mut contract_1 = Contract::new(Address::from_str("0xaa3ccffac657cac79dc06226b8d7fcc380000001").unwrap());
    contract_1.abi = Some(abi);


    let raw_abi = "[{\"type\":\"function\",\"name\":\"name\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"approve\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"totalSupply\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transferFrom\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"decimals\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"withdrawEther\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"burn\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"balanceOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"owner\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"symbol\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"freezeOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"allowance\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false}, {\"type\":\"error\",\"name\":\"transferFromFailed\",\"inputs\":[]}]";
    let abi: Vec<ABIStructure> = serde_json::from_str(raw_abi).unwrap();
    let abi = ContractABI::new(abi);

    let mut contract_2 = Contract::new(Address::from_str("0xaa3ccffac657cac79dc06226b8d7fcc380000002").unwrap());
    contract_2.abi = Some(abi);

    contract_1.insert_or_update(&client).await.unwrap();
    contract_2.insert_or_update(&client).await.unwrap();

    assert!(true);
}

#[test]
fn check_is_erc20() {

    let raw_abis: Vec<&str> = vec![
        // bnb
        "[{\"type\":\"function\",\"name\":\"name\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"approve\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"totalSupply\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transferFrom\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"decimals\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"withdrawEther\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"burn\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"balanceOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"owner\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"symbol\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"freezeOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"allowance\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false}]",

    ];

    raw_abis.iter().for_each(|raw_abi| {
        let abi: Vec<ABIStructure> = serde_json::from_str(raw_abi).unwrap();
        let mut contract = Contract::new(Address::from_str("0xce1f2c3139dae247bdd916056cb7c244defc8dd6").unwrap());
        contract.abi = Some(ContractABI::new(abi));

        assert_eq!(contract.erc20_compliancy(), 6);
    });
}

#[tokio::test]
async fn analyze_erc20() {

    let endpoint = std::env::var("ETH_ENDPOINT").unwrap_or("https://eth-mainnet.g.alchemy.com/v2/a05hbYFqpYLCAQGD4Q-PrX8TaPxcTDI-".to_string());

    let raw_abis: Vec<&str> = vec![
        // bnb
        "[{\"type\":\"function\",\"name\":\"name\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"approve\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"totalSupply\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transferFrom\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"decimals\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"withdrawEther\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"burn\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"function\",\"name\":\"unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Unfreeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"balanceOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"owner\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"symbol\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bytes memory\",\"type\":\"bytes memory\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"freezeOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false},{\"type\":\"function\",\"name\":\"freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Freeze\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"allowance\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"constant\":false}]",

    ];

    for raw_abi in raw_abis.iter() {
        let abi: Vec<ABIStructure> = serde_json::from_str(raw_abi).unwrap();
        let mut contract = Contract::new(Address::from_str("0xB8c77482e45F1F44dE1745F52C74426C631bDD52").unwrap());
        contract.abi = Some(ContractABI::new(abi));

        let provider = Http::new(Url::parse(endpoint.as_str()).unwrap());
        let eth_client = RetryClientBuilder::default()
            .rate_limit_retries(10)
            .timeout_retries(3)
            .initial_backoff(Duration::from_millis(500))
            .compute_units_per_second(330)
            .build(provider, Box::<ethers::providers::HttpRateLimitRetryPolicy>::default());
        
        contract.analyze(&eth_client).await.unwrap();
    };
}

#[test]
fn check_is_erc721() {

    let raw_abis: Vec<&str> = vec![
        // Ethereum Name Service
        "[{\"type\":\"function\",\"name\":\"supportsInterface\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"bytes4\",\"type\":\"bytes4\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"getApproved\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"approve\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Approval\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"registerOnly\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"transferFrom\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"reclaim\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"ens\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"safeTransferFrom\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"setResolver\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"ownerOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"balanceOf\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"renounceOwnership\",\"inputs\":[],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"OwnershipTransferred\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}]},{\"type\":\"function\",\"name\":\"owner\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"address\",\"type\":\"address\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"isOwner\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"available\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"setApprovalForAll\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"ApprovalForAll\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"bool\",\"type\":\"bool\"}]},{\"type\":\"function\",\"name\":\"addController\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"ControllerAdded\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}]},{\"type\":\"function\",\"name\":\"safeTransferFrom\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"},{\"name\":\"arg3\",\"internalType\":\"bytes\",\"type\":\"bytes\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"Transfer\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}]},{\"type\":\"function\",\"name\":\"GRACE_PERIOD\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"renew\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"},{\"name\":\"arg1\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"nameExpires\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"controllers\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"baseNode\",\"inputs\":[],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"isApprovedForAll\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"ret0\",\"internalType\":\"bool\",\"type\":\"bool\"}],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"function\",\"name\":\"transferOwnership\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"OwnershipTransferred\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"}]},{\"type\":\"function\",\"name\":\"removeController\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false},{\"type\":\"event\",\"name\":\"ControllerRemoved\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"address\",\"type\":\"address\"}]},{\"type\":\"function\",\"name\":\"register\",\"inputs\":[{\"name\":\"arg0\",\"internalType\":\"uint256\",\"type\":\"uint256\"},{\"name\":\"arg1\",\"internalType\":\"address\",\"type\":\"address\"},{\"name\":\"arg2\",\"internalType\":\"uint256\",\"type\":\"uint256\"}],\"outputs\":[],\"stateMutability\":\"payable\",\"constant\":false}]",

    ];

    raw_abis.iter().for_each(|raw_abi| {
        let abi: Vec<ABIStructure> = serde_json::from_str(raw_abi).unwrap();
        let mut contract = Contract::new(Address::from_str("0xce1f2c3139dae247bdd916056cb7c244defc8dd6").unwrap());
        contract.abi = Some(ContractABI::new(abi));

        assert_eq!(contract.erc721_compliancy(), 9);
    });
}